CREATE DATABASE IF NOT EXISTS vms;
USE vms;



CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(150) NOT NULL,
    role ENUM('admin', 'security', 'employee') NOT NULL,
    employee_code VARCHAR(50) DEFAULT NULL,
    department VARCHAR(100) DEFAULT NULL,
    phone_number VARCHAR(10) DEFAULT NULL,
    is_active TINYINT(1) DEFAULT 1,
    created DATETIME DEFAULT CURRENT_TIMESTAMP,
    modified DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);



CREATE TABLE visit_reasons (
    id INT AUTO_INCREMENT PRIMARY KEY,
    reason_name VARCHAR(100) NOT NULL,
    is_active TINYINT(1) DEFAULT 1,
    created DATETIME DEFAULT CURRENT_TIMESTAMP
);



CREATE TABLE visitor_master (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    mobile_number VARCHAR(10) NOT NULL,
    email VARCHAR(150) DEFAULT NULL,
    address VARCHAR(250) DEFAULT NULL,
    company_name VARCHAR(150) DEFAULT NULL,
    photo VARCHAR(255) DEFAULT NULL,
    created DATETIME DEFAULT CURRENT_TIMESTAMP,
    modified DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_mobile (mobile_number)
);



CREATE TABLE visits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    visitor_id INT DEFAULT NULL,
    visit_type ENUM('single', 'group') NOT NULL,
    group_name VARCHAR(150) DEFAULT NULL,
    visit_date DATE NOT NULL,
    visit_time TIME NOT NULL,
    visit_reason_id INT NOT NULL,
    host_id INT NOT NULL,
    host_department VARCHAR(100) DEFAULT NULL,
    host_phone VARCHAR(10) DEFAULT NULL,
    note_to_host TEXT DEFAULT NULL,
    approval_status ENUM('pending', 'approved', 'rejected', 'no_response') DEFAULT 'pending',
    check_in_time DATETIME DEFAULT NULL,
    check_out_time DATETIME DEFAULT NULL,
    visitor_card_number VARCHAR(50) DEFAULT NULL,
    is_pre_registered TINYINT(1) DEFAULT 0,
    qr_code VARCHAR(255) DEFAULT NULL,
    created_by INT NOT NULL,
    created_role ENUM('security', 'employee') NOT NULL,
    created DATETIME DEFAULT CURRENT_TIMESTAMP,
    modified DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (visitor_id) REFERENCES visitor_master(id) ON DELETE SET NULL,
    FOREIGN KEY (visit_reason_id) REFERENCES visit_reasons(id),
    FOREIGN KEY (host_id) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);



CREATE TABLE visit_details (
    id INT AUTO_INCREMENT PRIMARY KEY,
    visit_id INT NOT NULL,
    visitor_id INT DEFAULT NULL,
    name VARCHAR(100) NOT NULL,
    mobile_number VARCHAR(10) NOT NULL,
    email VARCHAR(150) DEFAULT NULL,
    address VARCHAR(250) DEFAULT NULL,
    company_name VARCHAR(150) DEFAULT NULL,
    photo VARCHAR(255) DEFAULT NULL,
    FOREIGN KEY (visit_id) REFERENCES visits(id) ON DELETE CASCADE,
    FOREIGN KEY (visitor_id) REFERENCES visitor_master(id) ON DELETE SET NULL
);



CREATE TABLE visitor_notification_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    visit_id INT NOT NULL,
    recipient_type ENUM('host', 'visitor') NOT NULL,
    recipient_email VARCHAR(150) DEFAULT NULL,
    recipient_mobile VARCHAR(10) DEFAULT NULL,
    notification_type ENUM('email', 'sms') NOT NULL,
    subject VARCHAR(255) DEFAULT NULL,
    message TEXT DEFAULT NULL,
    status ENUM('sent', 'failed') DEFAULT 'sent',
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (visit_id) REFERENCES visits(id) ON DELETE CASCADE
);



INSERT INTO users (username, password, email, role, employee_code, department, phone_number) VALUES
('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin@lava.com', 'admin', 'EMP001', 'Administration', '9876543210'),
('security', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'security@lava.com', 'security', 'SEC001', 'Security', '9876543211'),
('employee', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'employee@lava.com', 'employee', 'EMP002', 'IT Department', '9876543212');



INSERT INTO visit_reasons (reason_name) VALUES
('Meeting'),
('Interview'),
('Delivery'),
('Official Work'),
('Personal Visit'),
('Vendor Meeting'),
('Client Meeting');

show tables;